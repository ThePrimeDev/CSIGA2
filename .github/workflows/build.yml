name: Linux

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          mesa-common-dev \
          libglvnd-dev \
          libx11-dev \
          libxext-dev \
          libxi-dev \
          libxcursor-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxss-dev \
          libxtst-dev \
          libxfixes-dev \
          libxrender-dev \
          pkg-config \
          libavformat-dev \
          libavcodec-dev \
          libswscale-dev \
          libswresample-dev \
          libavutil-dev \
          g++-14 \
          zip
    - name: checkout external dependencies
      run: |
        mkdir -p external
        git clone --depth 1 https://github.com/libsdl-org/SDL external/SDL
        git clone --depth 1 -b docking https://github.com/ocornut/imgui external/imgui
    - name: configure
      run: cmake -S . -B build -DCSIGA2_FUN=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=g++-14
    - name: build source
      run: cmake --build build --target prod
    - name: Archive build/prod
      run: |
        # create a reproducible zip of the built prod folder
        zip -r build/prod.zip build/prod
        ls -lah build/prod.zip
    - name: Upload prod artifact
      uses: actions/upload-artifact@v4
      with:
        name: prod-zip
        path: build/prod.zip

  release:
    runs-on: ubuntu-22.04
    needs: build
    if: github.event_name == 'push'
    steps:
      - name: Download prod artifact
        uses: actions/download-artifact@v4
        with:
          name: prod-zip
          path: ./release
      - name: Create GitHub release and upload asset
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: build-${{ github.run_number }}
          name: Automated build ${{ github.run_number }}
          files: release/prod.zip