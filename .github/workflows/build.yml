name: Linux

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        compiler: [g++-11, g++-12, g++-13, g++-14, g++-15, clang++-18, clang++-19, clang++-20, clang++-21]
        configuration: [Debug, Release]
        exclude:
          - os: ubuntu-22.04
            compiler: g++-13
          - os: ubuntu-22.04
            compiler: g++-14
          - os: ubuntu-22.04
            compiler: g++-15
          - os: ubuntu-22.04
            compiler: clang++-18
          - os: ubuntu-22.04
            compiler: clang++-19
          - os: ubuntu-22.04
            compiler: clang++-20
          - os: ubuntu-22.04
            compiler: clang++-21
          - os: ubuntu-24.04
            compiler: g++-11
          - os: ubuntu-24.04
            compiler: g++-12
        include:
          - os: ubuntu-24.04
            compiler: g++-15
            container: ubuntu:25.04

    container: ${{ matrix.container }}

    steps:
    - uses: actions/checkout@v4
    - name: prepare clang++-19
      if: matrix.compiler == 'clang++-19'
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 19
    - name: prepare clang++-20
      if: matrix.compiler == 'clang++-20'
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 20
    - name: prepare clang++-21
      if: matrix.compiler == 'clang++-21'
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 21
    - name: prepare in docker
      if: matrix.container
      run: |
        apt update
        apt install -y cmake git g++-15
    - name: checkout external dependencies
      run: |
        mkdir -p external
        git clone --depth 1 https://github.com/libsdl-org/SDL external/SDL
        git clone --depth 1 -b docking https://github.com/ocornut/imgui external/imgui
    - name: configure
      run: cmake -S . -B build -DCSIGA2_FUN=OFF
    - name: build source
      run: cmake --build build --target prod
    - name: Archive build/prod (only from the Release matrix entry)
      if: matrix.os == 'ubuntu-24.04' && matrix.compiler == 'g++-15' && matrix.configuration == 'Release'
      run: |
        # create a reproducible zip of the built prod folder
        python -m zipfile -r build/prod.zip build/prod
        ls -lah build/prod.zip
    - name: Upload prod artifact
      if: matrix.os == 'ubuntu-24.04' && matrix.compiler == 'g++-15' && matrix.configuration == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: prod-zip
        path: build/prod.zip

  release:
    runs-on: ubuntu-22.04
    needs: build
    if: github.event_name == 'push'
    steps:
      - name: Download prod artifact
        uses: actions/download-artifact@v4
        with:
          name: prod-zip
          path: ./release
      - name: Create GitHub release and upload asset
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: build-${{ github.run_number }}
          name: Automated build ${{ github.run_number }}
          files: release/prod.zip